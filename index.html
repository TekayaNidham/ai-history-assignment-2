<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ELIZA (PhD Trauma / Vienna Edition)</title>
  <!-- Load Pyodide from CDN -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f0f0f0;
    }
    h1 {
      margin-bottom: 5px;
    }
    #chat-window {
      border: 1px solid #aaa;
      width: 100%;
      max-width: 600px;
      height: 300px;
      overflow-y: auto;
      padding: 5px;
      background: white;
    }
    .chat-line {
      margin: 5px 0;
    }
    .chat-eliza {
      color: #555;
    }
    .chat-user {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ELIZA (PhD Trauma / Vienna Edition)</h1>
  <div id="chat-window">
    <div class="chat-line chat-eliza">
      <strong>ELIZA:</strong> Hello! Let's talk about your PhD, life in Vienna, or anything on your mind.
    </div>
  </div>
  <br>
  <input id="user-input" type="text" style="width: 80%;" placeholder="Type your message...">
  <button onclick="sendMessage()">Send</button>

  <script>
    let pyodide;
    let pyodideReadyPromise;

    // We'll load Pyodide and then define our Python code
    async function main() {
      // 1) Load Pyodide
      pyodide = await loadPyodide({ indexURL : "https://cdn.jsdelivr.net/pyodide/v0.23.3/full/" });
      
      // 2) Our Python code, including the reflection, rules, and generate_response function
      //    You can replace this with your FULL code from eliza_knowledge.py
      const pythonCode = `
import re, random

# ---------------------------
# Reflection dictionary (short version)
# Replace with your full REFLECTIONS if needed
# ---------------------------
REFLECTIONS = {
    r"\\\\bI\\\\b": "you",
    r"\\\\bI'm\\\\b": "you're",
    r"\\\\bme\\\\b": "you",
    r"\\\\bmy\\\\b": "your",
    r"\\\\bam\\\\b": "are",
    r"\\\\byou\\\\b": "I"
}

# ---------------------------
# RULES (short version)
# Replace with your full expanded RULES
# ---------------------------
RULES = [
    (r"^[Hh]ello|^[Hh]i|^[Hh]ey(.*)",
     ["Hello... Feel free to talk about your PhD struggles, Vienna life, or anything else.",
      "Hi there! How can I help you today regarding your PhD, trauma, or living in Vienna?",
      "Hey! What's on your mind related to academia, politics, or personal well-being?"]),

    (r"(.*)\\bhow are you\\b(.*)",
     ["I'm just a program, but let's focus on you. How are you feeling?",
      "I'm doing fine in code form. How about you, especially regarding your PhD or Vienna life?"]),

    (r"(.*)",
     ["I'm here to listen. Could you tell me more?",
      "Could you elaborate on that?",
      "Please, continue. I'm listening.",
      "I see. Is there more you'd like to share?"])
]

def reflect(fragment):
    if fragment is None:
        return ""
    for pattern, replacement in REFLECTIONS.items():
        fragment = re.sub(pattern, replacement, fragment, flags=re.IGNORECASE)
    return fragment

def generate_response(user_input):
    # Attempt to match each pattern in RULES
    for (pattern, responses) in RULES:
        match = re.match(pattern, user_input, re.IGNORECASE)
        if match:
            response_template = random.choice(responses)
            result = response_template
            # For each capturing group, reflect it
            for i in range(1, len(match.groups()) + 1):
                group_text = match.group(i)
                if group_text is None:
                    group_text = ""
                group_text = reflect(group_text)
                placeholder = f"{{{{{i}}}}}"
                result = result.replace(placeholder, group_text)
            return result
    # If nothing matches (shouldn't happen if we have a catch-all)
    return "I'm not sure I understand. Could you elaborate?"

def eliza_reply(user_input):
    return generate_response(user_input)
`;

      // 3) Run the Python code inside Pyodide
      await pyodide.runPythonAsync(pythonCode);
    }

    // We'll have a helper function to call eliza_reply from JS
    async function elizaReplyJs(userText) {
      const code = `eliza_reply("""${userText.replace(/"/g, '\\"')}""")`;
      let response = await pyodide.runPythonAsync(code);
      return response;
    }

    // The chat logic in JavaScript:
    async function sendMessage() {
      const userInputElem = document.getElementById("user-input");
      const userInput = userInputElem.value.trim();
      if (!userInput) return;

      // Display user message in chat
      const chatWindow = document.getElementById("chat-window");
      chatWindow.innerHTML += `
        <div class="chat-line chat-user">
          <strong>YOU:</strong> ${userInput}
        </div>
      `;

      // Call the Python function to get a response
      const reply = await elizaReplyJs(userInput);

      // Display ELIZA's reply
      chatWindow.innerHTML += `
        <div class="chat-line chat-eliza">
          <strong>ELIZA:</strong> ${reply}
        </div>
      `;
      // Scroll to bottom
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Clear the input field
      userInputElem.value = "";
      userInputElem.focus();
    }

    // Initiate Pyodide as soon as the page loads
    pyodideReadyPromise = main();
  </script>
</body>
</html>
